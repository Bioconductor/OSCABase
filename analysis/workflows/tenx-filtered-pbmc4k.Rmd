<!-- AUTOMATICALLY GENERATED, DO NOT EDIT! -->

# PBMC 4k 10X dataset (filtered)

```{r setup, echo=FALSE, results="asis"}
library(OSCAUtils)
chapterPreamble(use_cache = TRUE)
```

## Introduction

This performs an analysis of the public PBMC 4k dataset generated by 10X Genomics [@zheng2017massively],
starting from the filtered count matrix.

## Analysis code

### Data loading

```{r loading}
library(TENxPBMCData)
pbmc4k <- TENxPBMCData('pbmc4k')
```

### Quality control

```{r}
unfiltered <- pbmc4k
```

Cell calling implicitly serves as a QC step to remove libraries with low total counts and number of detected genes.
Thus, we will only filter on the mitochondrial proportion.

```{r quality-control}
is.mito <- grep("MT", rowData(pbmc4k)$Symbol_TENx)

library(scater)
stats <- perCellQCMetrics(pbmc4k, subsets=list(Mito=is.mito))
high.mito <- isOutlier(stats$subsets_Mito_percent, nmads=3, type="higher")
pbmc4k <- pbmc4k[,!high.mito]
```

### Normalization

```{r normalization}
pbmc4k <- logNormCounts(pbmc4k)
```

### Variance modelling

```{r variance-modelling}
library(scran)
dec4k <- modelGeneVar(pbmc4k)
chosen.hvgs <- getTopHVGs(dec4k, prop=0.1)
```

### Dimensionality reduction

We use randomized SVD, which is more efficient for file-backed matrices.

```{r dimensionality-reduction}
set.seed(10000)
pbmc4k <- runPCA(pbmc4k, subset_row=chosen.hvgs, ncomponents=25,
    BSPARAM=BiocSingular::RandomParam())

set.seed(100000)
pbmc4k <- runTSNE(pbmc4k, dimred="PCA")

set.seed(1000000)
pbmc4k <- runUMAP(pbmc4k, dimred="PCA")
```

### Clustering

```{r clustering}
g <- buildSNNGraph(pbmc4k, k=10, use.dimred = 'PCA')
clust <- igraph::cluster_walktrap(g)$membership
pbmc4k$cluster <- factor(clust)
```

## Results

### Quality control statistics

```{r, fig.wide=TRUE}
colData(unfiltered) <- cbind(colData(unfiltered), stats)
unfiltered$discard <- high.mito

gridExtra::grid.arrange(
    plotColData(unfiltered, y="sum", colour_by="discard") +
        scale_y_log10() + ggtitle("Total count"),
    plotColData(unfiltered, y="detected", colour_by="discard") +
        scale_y_log10() + ggtitle("Detected features"),
    plotColData(unfiltered, y="subsets_Mito_percent",
        colour_by="discard") + ggtitle("Mito percent"),
    ncol=2
)
```

```{r}
plotColData(unfiltered, x="sum", y="subsets_Mito_percent",
    colour_by="discard") + scale_x_log10()
```

```{r}
summary(high.mito)
```

### Normalization

```{r}
summary(sizeFactors(pbmc4k))
```

### Variance modelling

```{r}
plot(dec4k$mean, dec4k$total, pch=16, cex=0.5,
    xlab="Mean of log-expression", ylab="Variance of log-expression")
curfit <- metadata(dec4k)
curve(curfit$trend(x), col='dodgerblue', add=TRUE, lwd=2)
```

### Clustering

```{r}
table(pbmc4k$cluster)
```

```{r}
plotTSNE(pbmc4k, colour_by="cluster")
```


## Session Info {-}

```{r sessionInfo, echo=FALSE, results='asis'}
prettySessionInfo()
```
