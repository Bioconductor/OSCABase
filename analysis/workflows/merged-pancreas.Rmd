# Merged human pancreas datasets

```{r setup, echo=FALSE, results="asis"}
library(OSCAUtils)
chapterPreamble(use_cache = TRUE)
```

## Introduction

For a period in 2016, there was a great deal of interest in using scRNA-seq to profile the human pancreas at cellular resolution
[@muraro2016singlecell;@grun2016denovo;@lawlor2017singlecell;@segerstolpe2016singlcell].
As a consequence, we have a surplus of human pancreas datasets generated by different authors with different technologies,
which provides an ideal use case for demonstrating more complex data integration strategies.
This represents a more challenging application than the PBMC dataset in Chapter \@ref(integrating-datasets) as it involves different sequencing protocols and different patients, most likely with differences in cell type composition.

## The good

We start by considering only two datasets from @muraro2016singlecell and @grun2016denovo.
This is a relatively simple scenario involving very similar protocols (CEL-seq and CEL-seq2) and a similar set of authors.

```{r, results='asis', echo=FALSE}
WFUN <- function(x) {
    if (file.exists("workflows")) file.path("workflows", x) else x
}
extractCached(WFUN("grun-pancreas"), "variance-modelling",
    c("sce.grun", "dec.grun"))
```

```{r}
sce.grun
```

```{r, results='asis', echo=FALSE}
extractCached(WFUN("muraro-pancreas"), "variance-modelling",
    c("sce.muraro", "dec.muraro"))
```

```{r}
sce.muraro
```

We subset both batches to their common universe of genes;
adjust their scaling to equalize sequencing coverage (not really necessary in this case, as the coverage is already similar, but we will do so anyway for consistency);
and select those genes with positive average biological components for further use.

```{r}
universe <- intersect(rownames(sce.grun), rownames(sce.muraro))
sce.grun2 <- sce.grun[universe,]
dec.grun2 <- dec.grun[universe,]
sce.muraro2 <- sce.muraro[universe,]
dec.muraro2 <- dec.muraro[universe,]

library(batchelor)
normed.pancreas <- multiBatchNorm(sce.grun2, sce.muraro2)
sce.grun2 <- normed.pancreas[[1]]
sce.muraro2 <- normed.pancreas[[2]]

library(scran)
combined.pan <- combineVar(dec.grun2, dec.muraro2)
chosen.genes <- rownames(combined.pan)[combined.pan$bio > 0]
```

We observe that `rescaleBatches()` is unable to align cells from different batches in Figure \@ref(fig:tsne-pancreas-rescaled).
This is attributable to differences in population composition between batches, with additional complications from non-linearities in the batch effect, e.g., when the magnitude or direction of the batch effect differs between cell types.

```{r tsne-pancreas-rescaled, fig.asp=0.5, fig.cap="$t$-SNE plot of the two pancreas datasets after correction with `rescaleBatches()`. Each point represents a cell and is colored according to the batch of origin."}
library(scater)
rescaled.pancreas <- rescaleBatches(sce.grun2, sce.muraro2)
rescaled.pancreas <- runPCA(rescaled.pancreas, subset_row=chosen.genes,
    exprs_values="corrected")

rescaled.pancreas <- runTSNE(rescaled.pancreas, dimred="PCA")
plotTSNE(rescaled.pancreas, colour_by="batch")
```

Here, we use `fastMNN()` to merge together the two human pancreas datasets described earlier.
Clustering on the merged datasets yields fewer batch-specific clusters, which is recapitulated as greater intermingling between batches in Figure \@ref(fig:tsne-pancreas-mnn).
This improvement over Figure \@ref(fig:tsne-pancreas-rescaled) represents the ability of `fastMNN()` to adapt to more complex situations involving differences in population composition between batches.

```{r tsne-pancreas-mnn, fig.asp=0.5, fig.cap="$t$-SNE plot of the two pancreas datasets after correction with `fastMNN()`. Each point represents a cell and is colored according to the batch of origin."}
mnn.pancreas <- fastMNN(sce.grun2, sce.muraro2, subset.row=chosen.genes)

snn.gr <- buildSNNGraph(mnn.pancreas, use.dimred="corrected")
clusters <- igraph::cluster_walktrap(snn.gr)$membership
tab <- table(Cluster=clusters, Batch=mnn.pancreas$batch)
tab

mnn.pancreas <- runTSNE(mnn.pancreas, dimred="corrected")
plotTSNE(mnn.pancreas, colour_by="batch")
```

```{r, echo=FALSE}
stopifnot(mean(rowSums(tab==0)==1) < 0.2) # Most clusters have non-zero contributions.
```

## The bad

Flushed with our previous success, we now attempt to merge the other datasets from @lawlor2017singlecell and @segerstolpe2016singlcell.
This is a more challenging task as it involves different technologies, mixtures of UMI and read count data and a more diverse set of authors (presumably with greater differences in the patient population).

```{r, results='asis', echo=FALSE}
extractCached(WFUN("lawlor-pancreas"), "variance-modelling",
    c("sce.lawlor", "dec.lawlor"))
```

```{r}
sce.lawlor
```

```{r, results='asis', echo=FALSE}
extractCached(WFUN("segerstolpe-pancreas"), "variance-modelling",
    c("sce.seger", "dec.seger"))
```

```{r}
sce.seger
```

We perform the usual routine to obtain re-normalized values and a set of HVGs. 

```{r}
universe <- Reduce(intersect, list(rownames(sce.grun), rownames(sce.muraro),
    rownames(sce.lawlor), rownames(sce.seger)))

# Could use a loop here... but I like typing.
sce.grun2 <- sce.grun[universe,]
dec.grun2 <- dec.grun[universe,]
sce.muraro2 <- sce.muraro[universe,]
dec.muraro2 <- dec.muraro[universe,]
sce.lawlor2 <- sce.lawlor[universe,]
dec.lawlor2 <- dec.lawlor[universe,]
sce.seger2 <- sce.seger[universe,]
dec.seger2 <- dec.seger[universe,]

normed.pancreas <- multiBatchNorm(sce.grun2, sce.muraro2, sce.lawlor2, sce.seger2)
sce.grun2 <- normed.pancreas[[1]]
sce.muraro2 <- normed.pancreas[[2]]
sce.lawlor2 <- normed.pancreas[[3]]
sce.seger2 <- normed.pancreas[[4]]

combined.pan <- combineVar(dec.grun2, dec.muraro2, dec.lawlor2, dec.seger2)
chosen.genes <- rownames(combined.pan)[combined.pan$bio > 0]
```

We observe that the merge is generally successful, with many clusters containing contributions from each batch (Figure \@ref(fig:tsne-pancreas-mnn-many)).
There are few clusters that are specific to the Segerstolpe dataset, and if we were naive, we might consider them to represent interesting subpopulations that are not present in the other datasets.

```{r tsne-pancreas-mnn-many, fig.asp=0.5, fig.cap="$t$-SNE plots of the four pancreas datasets after correction with `fastMNN()`. Each point represents a cell and is colored according to the batch of origin (left) or the cluster (right). The cluster label is shown at the median location across all cells in the cluster."}
mnn.pancreas <- fastMNN(Grun=sce.grun2, Muraro=sce.muraro2, 
    Lawlor=sce.lawlor2, Seger=sce.seger2, subset.row=chosen.genes)

snn.gr <- buildSNNGraph(mnn.pancreas, use.dimred="corrected")
clusters <- igraph::cluster_walktrap(snn.gr)$membership
tab <- table(Cluster=clusters, Batch=mnn.pancreas$batch)
tab

mnn.pancreas <- runTSNE(mnn.pancreas, dimred="corrected")
gridExtra::grid.arrange(
    plotTSNE(mnn.pancreas, colour_by="batch", text_by=I(clusters)),
    plotTSNE(mnn.pancreas, colour_by=I(factor(clusters)), text_by=I(clusters)),
    ncol=2
)
```

```{r}
stopifnot(any(tab[,"Seger"]==rowSums(tab)))
```

Fortunately, we are battle-hardened and cynical, and we are sure to check for other sources of variation in this dataset.
The most obvious candidate is the donor of origin for each cell (Figure \@ref(fig:tsne-pancreas-mnn-donor)), which correlates perfectly to these Segerstolpe-only clusters.
Needless to say, donor-level variation is less interesting for the purposes of this analysis.
(That said, it is worth noting that preservation of the within-dataset donor effects is the correct course of action here, as a batch correction method aim to avoid removing heterogeneity within each specified batch.)

```{r tsne-pancreas-mnn-donor, fig.cap="$t$-SNE plots of the four pancreas datasets after correction with `fastMNN()`. Each point represents a cell and is colored according to the donor of origin for the Segerstolpe dataset."}
donors <- c(sce.grun2$donor, sce.muraro2$donor,
    sce.lawlor2$`islet unos id`, sce.seger2$Donor)
seger.donors <- donors
seger.donors[mnn.pancreas$batch!="Seger"] <- NA
plotTSNE(mnn.pancreas, colour_by=I(seger.donors))
```

## The ugly

```{r}
combined <- noCorrect(Grun=sce.grun2, Muraro=sce.muraro2, 
    Lawlor=sce.lawlor2, Seger=sce.seger2)
assayNames(combined) <- "logcounts"
```

```{r}
donors.by.batches <- lapply(split(donors, combined$batch), unique)
donors.by.batches <- lapply(donors.by.batches, sort)
donors.by.batches
```

```{r}
ndonors <- rep(lengths(donors.by.batches), lengths(donors.by.batches))
names(ndonors) <- unlist(donors.by.batches)
ndonors

set.seed(1010100)
multiout <- fastMNN(combined, batch=donors, subset.row=chosen.genes,
    weights=1/ndonors,
    merge.order=list(
        donors.by.batches[c("Grun", "Muraro")],
        donors.by.batches[c("Seger", "Lawlor")]
    )
)
```

```{r}
library(scater)
g <- buildSNNGraph(multiout, use.dimred=1)
clusters <- igraph::cluster_walktrap(g)$membership
table(clusters, combined$batch)

multiout <- runTSNE(multiout, dimred="corrected")
gridExtra::grid.arrange(
    plotTSNE(multiout, colour_by=I(combined$batch), text_by=I(clusters)),
    plotTSNE(multiout, colour_by=I(factor(clusters)), text_by=I(clusters)),
    ncol=2
)
```

```{r}
proposed <- c(rep(NA, ncol(sce.grun)), 
    sce.muraro$label,
    sce.lawlor$`cell type`,
    sce.seger$CellType)

proposed <- tolower(proposed)
proposed[proposed=="gamma/pp"] <- "gamma"
proposed[proposed=="pp"] <- "gamma"
proposed[proposed=="duct"] <- "ductal"
proposed[proposed=="psc"] <- "stellate"
table(proposed, clusters)

#collected <- do.call(noCorrect, unlist(all.batches, recursive=FALSE))
#markers <- findMarkers(collected, clusters, assay.type=1, direction="up", lfc=1, full.stats=TRUE, block=origin)
```
