<!-- AUTOMATICALLY GENERATED, DO NOT EDIT! -->

```{r, echo=FALSE}
knitr::opts_chunk$set(cache=TRUE, error=FALSE, warning=FALSE, message=FALSE)
```

```{r loading}
library(TENxPBMCData)
pbmc3k <- TENxPBMCData('pbmc3k')
```

```{r quality-control}
is.mito <- grep("MT", rowData(pbmc3k)$Symbol_TENx)

library(scater)
pbmc3k <- calculateQCMetrics(pbmc3k, feature_controls=list(Mito=is.mito))
high.mito <- isOutlier(pbmc3k$pct_counts_Mito, nmads=3, type="higher")
pbmc3k <- pbmc3k[,!high.mito]
```

```{r normalization}
pbmc3k <- normalize(pbmc3k)
```

```{r variance-modelling}
library(scran)
fit3k <- trendVar(pbmc3k, use.spikes = FALSE)
dec3k <- decomposeVar(pbmc3k, fit3k)
```

```{r feature-selection}
chosen.hvgs <- which(dec3k$bio > 0)
```

```{r dimensionality-reduction}
# Using randomized SVD, which is more efficient for 
# file-backed matrices.
set.seed(10000)
pbmc3k <- runPCA(pbmc3k, feature_set=chosen.hvgs, ncomponents=25,
    BSPARAM=BiocSingular::RandomParam())

set.seed(100000)
pbmc3k <- runTSNE(pbmc3k, use_dimred="PCA")

set.seed(1000000)
pbmc3k <- runUMAP(pbmc3k, use_dimred="PCA")
```

```{r clustering}
g <- buildSNNGraph(pbmc3k, k=10, use.dimred = 'PCA')
clust <- igraph::cluster_walktrap(g)$membership
pbmc3k$cluster <- factor(clust)
```
