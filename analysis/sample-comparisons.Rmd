---
output:
  html_document
bibliography: ../ref.bib
---

# Multi-sample comparisons

```{r setup, echo=FALSE, results="asis"}
source("workflows/knitr_options.R")
```

## Motivation

A powerful use of scRNA-seq technology lies in the design of replicated multi-condition experiments to detect changes in composition or expression between conditions.
For example, a researcher could use this strategy to detect changes in cell type abundance after drug treatment [@richard2018tcell] or genetic modifications [@scialdone2016resolving].
This provides more biological insight than conventional scRNA-seq experiments involving only one biological condition, especially if we can relate population changes to specific experimental perturbations.

Differential analyses of multi-condition scRNA-seq experiments can be broadly split into two categies - differential expression (DE) and differential abundance (DA) analyses.
The former tests for changes in expression between conditions for cells of the same type that are present in both conditions,
while the latter tests for changes in the composition of cell types (or states, etc.) between conditions.
In this chapter, we will demonstrate both analyses using data from a study of the early mouse embryo [@pijuansala2019single].

## Setting up the data

Our demonstration scRNA-seq dataset was generated from chimeric mouse embryos at the E8.5 developmental stage.
Each chimeric embryo was generated by injecting td-Tomato-positive embryonic stem cells (ESCs) into a wild-type (WT) blastocyst.
Unlike in previous experiments [@scialdone2016resolving], there is no genetic difference between the injected and background cells other than the expression of td-Tomato in the former.
Instead, the aim of this "wild-type chimera" study is to determine whether the injection procedure itself introduces differences in lineage commitment compared to the background cells^[Probably should have tested this at the start, to be honest.].

The experiment used a paired design with three replicate batches of two samples each.
Specifically, each batch contains one sample consisting of td-Tomato positive cells and another consisting of negative cells,
obtained by fluorescence-activated cell sorting from a single pool of dissociated cells from 6-7 chimeric embryos.
For each sample, scRNA-seq data was generated using the 10X Genomics protocol [@zheng2017massively] to obtain 2000-7000 cells.

```{r, echo=FALSE, results="asis"}
extractCached("workflows/pijuan-embryo", "dimensionality-reduction", "merged")
```

```{r}
merged
```

The differential analyses are predicated on many of the pre-processing steps covered in previous chapters.
For brevity, we will not explicitly repeat them here,
only noting that we have already merged cells from all samples into the same coordinate system (see Section ???)
and clustered the merged dataset to obtain a common partitioning across all samples.
A brief inspection of the results indicates that clusters contain similar contributions from all batches with only modest differences associated with td-Tomato expression (Figure \@ref(fig:tsne-initial)).

```{r tsne-initial, fig.wide=TRUE, fig.asp=0.5, fig.caption="$t$-SNE plot of the WT chimeric dataset, where each point represents a cell and is colored according to td-Tomato expression (left) or batch of origin (right). Cluster numbers are superimposed based on the median coordinate of cells assigned to that cluster."}
library(scater)
table(merged$cluster, merged$tomato)
table(merged$cluster, merged$pool)
gridExtra::grid.arrange(
    plotTSNE(merged, colour_by="tomato", text_by="cluster"),
    plotTSNE(merged, colour_by=data.frame(pool=factor(merged$pool))),
    ncol=2
)
```

Ordinarily, we would be obliged to perform marker detection to assign biological meaning to these clusters.
For simplicity, we will skip this step by directly using the cell type labels provided by @pijuansala2019single.
These were obtained by mapping the cells in this dataset to a larger, pre-annotated "atlas" of mouse early embryonic development.
While broadly consistent, many of our clusters map to multiple labels (Figure \@ref(fig:heat-cluster-label}), which reflects the difficulties in unambiguously resolving cell types undergoing differentiation.

```{r heat-cluster-label, fig.cap="Heatmap showing the abundance of cells with each combination of cluster (row) and cell type label (column). The color scale represents the log~2~-count for each combination."}
by.label <- table(merged$cluster, merged$celltype.mapped)
pheatmap::pheatmap(log2(by.label+1), cluster_cols=FALSE, cluster_rows=FALSE,
    color=viridis::viridis(101))
```

## Differential expression between conditions

### Creating pseudo-bulk samples

The most obvious differential analysis is to look for changes in expression between conditions.
We perform the DE analysis separately for each label to identify cell type-specific transcriptional effects of injection.
The actual DE testing is performed on "pseudo-bulk" expression profiles [@tung2017batch], 
generated by summing counts together for all cells with the same combination of label and sample.
This leverages the resolution offered by single-cell technologies to define the labels,
and combines it with the statistical rigor of bulk RNA-seq DE analyses.

```{r}
# Using 'label' and 'sample' as our two factors; each column of the output
# corresponds to one unique combination of these two factors.
summed <- aggregateAcrossCells(merged, 
    id=DataFrame(
        label=merged$celltype.mapped,
        sample=merged$sample)
)
summed
```

At this point, it is worth reflecting on the motivations behind the use of pseudo-bulking^[As opposed to real bulking. Side chest!].

- Larger counts are more amenable to downstream analysis with standard methods for bulk RNA-seq analysis.
Normalization is more straightforward and certain approximations are more accurate for large counts.
- Collapsing cells into samples reflects the fact that our biological replication occurs at the sample level [@lun2017overcoming].
Each sample is represented no more than once for each condition, avoiding problems from unmodelled correlations between samples. 
Supplying the per-cell counts directly would indicate that each cell is a biological replicate, which is not true from an experimental perspective.
- Variance between cells within each sample is masked, provided it does not affect variance across (replicate) samples.
This avoids penalizing DEGs that are not uniformly up- or down-regulated for all cells in all samples of one condition.
Masking is generally desirable as DEGs (unlike marker genes) do not need to have low within-sample variance to be interesting, e.g., if the treatment effect is consistent across populations but heterogeneous on a per-cell basis.

### Performing the DE analysis

#### Introduction

The DE analysis will be performed using quasi-likelihood (QL) methods from the `r Biocpkg("edgeR")` package [@robinson2010edgeR;@chen2016reads].
This uses a negative binomial generalized linear model (NB GLM) to handle overdispersed count data in experiments with limited replication.
In our case, we have biological variation with three replicates per condition, so `r Biocpkg("edgeR")` (or its contemporaries) is a natural choice for the analysis.

We arbitrarily pick one of the labels to use for this demonstration.
We do not use all labels in the DE analysis as the strong DE between labels makes it difficult to compute a sensible average abundance to model the mean-dispersion trend.
Label-specific batch effects would not be easily handled with a single additive term in the design matrix for the batch.
Finally, it is usually more convenient to fit a number of small generalized linear models (one per label) than to try to fit one large model involving all labels.

```{r}
label <- "Mesenchyme"
current <- summed[,label==summed$celltype.mapped]

# Creating up a DGEList object for use in edgeR:
library(edgeR)
y <- DGEList(counts(current), samples=colData(current))
y
```

#### Pre-processing

A typical step in bulk RNA-seq data analyses is to remove samples with very low library sizes corresponding to failed library preparation or sequencing.
In our situation, this is equivalent to removing label-sample combinations that have very few or lowly-sequenced cells.
The corresponding summed count vectors are likely to be highly variable and thus reduce power for DE detection.
The exact definition of "very low" will vary, but in this case, we define it to be log-library sizes that are more than 3 median absolute deviations from the median.

```{r}
discarded <- isOutlier(y$samples$lib.size, log=TRUE, type="lower", nmads=3)
y <- y[,!discarded]
summary(discarded)
```

Another typical step in bulk RNA-seq analyses is to remove genes that are lowly expressed.
This reduces computational work, improves the accuracy of mean-variance trend modelling and decreases the severity of the multiple testing correction.
Genes are discarded if they are not expressed above a log-CPM threshold in a minimum number of samples (determined from the size of the smallest treatment group in the experimental design). 

```{r}
keep <- filterByExpr(y, group=current$tomato)
y <- y[keep,]
summary(keep)
```

Finally, we correct for composition biases by computing normalization factors with the trimmed mean of M-values method [@robinson2010scaling].
We do not need the methods in Chapter ??? as the counts for our pseudo-bulk samples are large enough to apply bulk normalization methods.

```{r}
y <- calcNormFactors(y)
y$samples
```

#### Statistical modelling

We set up the design matrix to block on the batch differences between replicates,
while retaining a term that represents the effect of injection 
(i.e., the log-fold change of td-Tomato-positive cells over their negative counterparts within the same label).
Our aim is to test whether this log-fold change is significantly different from zero.

```{r}
design <- model.matrix(~factor(pool) + factor(tomato), y$samples)
design
```

We estimate the negative binomial (NB) dispersions with `estimateDisp()`.
The role of the NB dispersion is to model the mean-variance trend (Figure \@ref(fig:bcvplot)),
which is not easily accommodated by QL dispersions alone due to the quadratic nature of the NB mean-variance trend.

```{r bcvplot, fig.cap="Biological coefficient of variation (BCV) for each gene as a function of the average abundance. The BCV is computed as the square root of the NB dispersion after empirical Bayes shrinkage towards the trend. Trended and common BCV estimates are shown in blue and red, respectively."}
y <- estimateDisp(y, design)
summary(y$trended.dispersion)
plotBCV(y)
```

We also estimate the quasi-likelihood dispersions with `glmQLFit()` [@chen2016reads].
This fits a GLM to the counts for each gene and estimates the QL dispersion from the GLM deviance.
We set `robust=TRUE` to avoid distortions from highly variable clusters [@phipson2016robust].
The QL dispersion models the uncertainty and variability of the per-gene variance (Figure \@ref(fig:qlplot)) - which is not well handled by the NB dispersions, so the two dispersion types complement each other in the final analysis.

```{r qlplot, fig.cap="QL dispersion estimates for each gene as a function of abundance. Raw estimates (black) are shrunk towards the trend (blue) to yield squeezed estimates (red)."}
fit <- glmQLFit(y, design, robust=TRUE)
summary(fit$var.prior)
summary(fit$df.prior)
plotQLDisp(fit)
```

We test for differences in expression due to injection using `glmQLFTest()`.
DEGs are defined as those with non-zero log-fold changes at a false discovery rate of 5%.
Very few genes are significantly DE, indicating that injection has little effect on the transcriptome of "`r label`" cells.
(Note that this logic is somewhat circular, 
as a large transcriptional effect may have caused cells of this type to be re-assigned to a different label.
We discuss this in more detail in Section ??? below.)

```{r}
res <- glmQLFTest(fit, coef=ncol(design))
summary(decideTests(res))
topTags(res)
```

```{r, echo=FALSE}
# Making sure that the changes are in fact small!
stopifnot(mean(abs(decideTests(res))) < 0.005)
```

### Putting it all together

We repeat this process for each of the labels to identify injection-induced DE in each cell type.
This is mostly straightforward as we can write a loop that simply performs the DE analysis for each subset of columns in `summed`.
However, some additional care is required to automatically deal with labels that are not represented in both injected and background cells, for which a DE analysis between conditions is meaningless;
or are not represented in a sufficient number of replicate samples to enable modelling of biological variability.
This is represented by the extra checks related to `design` in the code chunk below.

```{r}
de.results <- list()
for (i in unique(summed$celltype.mapped)) {
    current <- summed[,i==summed$celltype.mapped]
    y <- DGEList(counts(current), samples=colData(current))

    discarded <- isOutlier(colSums(counts(current)), 
        log=TRUE, type="lower", nmads=3)
    y <- y[,!discarded]
    y <- y[filterByExpr(y, group=current$tomato),]
    y <- calcNormFactors(y)

    design <- try(
        model.matrix(~factor(pool) + factor(tomato), y$samples),
        silent=TRUE
    )
    if (is(design, "try-error") || 
        qr(design)$rank==nrow(design) ||
        qr(design)$rank < ncol(design)) 
    {
        # Skipping labels without contrasts or without 
        # enough residual d.f. to estimate the dispersion.
        next
    }

    y <- estimateDisp(y, design)
    fit <- glmQLFit(y, design)
    res <- glmQLFTest(fit, coef=ncol(design))
    de.results[[i]] <- res
}
```

We examine the numbers of DEGs at a FDR of 5% for each label.
In general, there seems to be very little differential expression that is introduced by injection.

```{r}
summaries <- lapply(de.results, FUN=function(x) summary(decideTests(x))[,1])
sum.tab <- do.call(rbind, summaries)
sum.tab
```

A survey of the DEGs from all labels identifies _Xist_ as being consistently downregulated in the injected cells.
This is consistent with the fact that the injected cells are male while the background cells are derived from pools of male and female embryos (due to experimental difficulties with resolving sex at this stage).
The consistent downregulation of _Phlda2_ and _Cdkn1c_ in the injected cells is also interesting, given that both are imprinted genes. 

```{r}
# TODO: easier consolidation.
degs <- lapply(de.results, FUN=function(x) rownames(topTags(x, p.value=0.05)))
common.degs <- sort(table(unlist(degs)), decreasing=TRUE)
head(common.degs, 20)
```

```{r, echo=FALSE}
# Check that the above paragraph is valid.
stopifnot("Xist" %in% names(head(common.degs, 20)))
stopifnot("Phlda2" %in% names(head(common.degs, 20)))
stopifnot("Cdkn1c" %in% names(head(common.degs, 20)))
```

We also list the labels that were skipped due to the absence of replicates or contrasts.
If it is necessary to extract statistics in the absence of replicates, several strategies can be applied such as reducing the complexity of the model or using a predefined value for the NB dispersion.
We refer readers to the `r Biocpkg("edgeR")` user's guide for more details.

```{r}
setdiff(unique(summed$celltype.mapped), names(summaries))
```

## Duality of DE and DA analyses

While useful, the distinction between DE and DA analyses is somewhat artificial when dealing with clusters defined from expression data.
To illustrate this duality, consider a scRNA-seq experiment involving a heterogeneous population and two biological conditions.
Assume we have a cell type $X$ present in both conditions.
Within $X$, some genes are differentially expressed between conditions.
This leads to two possible outcomes:

- The DE between conditions causes $X$ to form two separate clusters in expression space (or the low-dimensional space derived from the gene expression values).
This manifests as differential abundance where one cluster is enriched in each condition.
- The DE between conditions is not sufficient to split $X$ into two separate clusters, e.g., because `fastMNN()` identifies them as corresponding cell types and merges them together.
This means that the differences between conditions manifests directly as DE within the single cluster corresponding to $X$.

Thus, it is often necessary to consider both differential expression and abundance to fully characterize the differences between conditions in scRNA-seq experiments.

## Session Info

```{r sessionInfo, echo=FALSE, results='asis'}
prettySessionInfo()
```

## References {-}
